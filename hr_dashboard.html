<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nautical Universe – HR Dashboard</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <div class="login-container">
    <h2>Welcome HR – Nautical Universe</h2>

    <h3>Create Department</h3>
    <input type="text" id="departmentName" placeholder="Department Name" />
    <button onclick="createDepartment()">Create</button>

    <h3>Create Employee</h3>
    <input type="text" id="empName" placeholder="Employee Name" />
    <input type="text" id="empID" placeholder="Employee ID" />
    <input type="text" id="empPhone" placeholder="Phone Number" />
    <input type="email" id="empEmail" placeholder="Email" />
    <input type="text" id="empMarital" placeholder="Marital Status" />
    <input type="text" id="empEducation" placeholder="Education" />
    <input type="text" id="empExperience" placeholder="Past Experience" />
    <input type="text" id="empAddress" placeholder="Address" />
    <select id="empDepartment"></select>
    <input type="text" id="empManager" placeholder="Reporting Manager" />
    <input type="text" id="empDesignation" placeholder="Designation" />
    <input type="text" id="empBloodGroup" placeholder="Blood Group" />
    <input type="file" id="empPhoto" accept="image/*" />
    <input type="text" id="empUsername" placeholder="Login ID" />
    <input type="password" id="empPassword" placeholder="Password" />
    <button onclick="createEmployee()">Add Employee</button>

    <h3>All Attendance</h3>
    <div id="attendanceList"></div>

    <h3>Export Attendance</h3>
    <button onclick="exportAttendance()">Download CSV</button>

    <h3>Change Password</h3>
    <input type="password" id="oldPassword" placeholder="Old Password" />
    <input type="password" id="newPassword" placeholder="New Password" />
    <button onclick="changePassword()">Update Password</button>

    <h3>Logout</h3>
    <button onclick="logout()">Logout</button>
  </div>

  <script>
    const hrUser = localStorage.getItem("loggedInHR");
    if (!hrUser) {
      alert("No HR logged in. Redirecting to login page.");
      window.location.href = "index.html";
    }

    function getUsers() {
      return JSON.parse(localStorage.getItem("users")) || [];
    }

    function saveUsers(users) {
      localStorage.setItem("users", JSON.stringify(users));
    }

    function getAttendance() {
      return JSON.parse(localStorage.getItem("attendance")) || {};
    }

    function saveAttendance(attendance) {
      localStorage.setItem("attendance", JSON.stringify(attendance));
    }

    function getDepartments() {
      return JSON.parse(localStorage.getItem("departments")) || [];
    }

    function saveDepartments(depts) {
      localStorage.setItem("departments", JSON.stringify(depts));
    }

    function createDepartment() {
      const name = document.getElementById("departmentName").value;
      if (name) {
        const depts = getDepartments();
        depts.push(name);
        saveDepartments(depts);
        alert("Department created: " + name);
        populateDepartments();
      }
    }

    function populateDepartments() {
      const select = document.getElementById("empDepartment");
      select.innerHTML = "";
      getDepartments().forEach(dept => {
        const option = document.createElement("option");
        option.value = dept;
        option.textContent = dept;
        select.appendChild(option);
      });
    }

    function createEmployee() {
      const photoInput = document.getElementById("empPhoto");
      let photoData = "";
      if (photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          photoData = e.target.result;
          saveEmployee(photoData);
        };
        reader.readAsDataURL(photoInput.files[0]);
      } else {
        saveEmployee("");
      }
    }

    function saveEmployee(photoData) {
      const users = getUsers();
      const employee = {
        role: "Employee",
        username: document.getElementById("empUsername").value,
        password: document.getElementById("empPassword").value,
        photo: photoData,
        profile: {
          name: document.getElementById("empName").value,
          id: document.getElementById("empID").value,
          phone: document.getElementById("empPhone").value,
          email: document.getElementById("empEmail").value,
          marital: document.getElementById("empMarital").value,
          education: document.getElementById("empEducation").value,
          experience: document.getElementById("empExperience").value,
          address: document.getElementById("empAddress").value,
          department: document.getElementById("empDepartment").value,
          manager: document.getElementById("empManager").value,
          designation: document.getElementById("empDesignation").value,
          bloodGroup: document.getElementById("empBloodGroup").value,
          exit: null
        }
      };
      users.push(employee);
      saveUsers(users);
      alert("Employee added: " + employee.username);
    }

    function showAttendance() {
      const attendance = getAttendance();
      const container = document.getElementById("attendanceList");
      container.innerHTML = "";

      const users = getUsers();
      users.forEach(user => {
        if (user.role === "Employee") {
          const records = attendance[user.username] || [];
          const div = document.createElement("div");
          div.innerHTML = `
            <strong>${user.username}</strong>: ${records.join(", ") || "No attendance yet"}
            <button onclick="markExit('${user.username}')">Mark Exit</button>
          `;
          container.appendChild(div);
        }
      });
    }

    function markExit(username) {
      const users = getUsers();
      const user = users.find(u => u.username === username);
      const date = prompt("Exit Date (YYYY-MM-DD):");
      const reason = prompt("Exit Reason:");
      const interview = confirm("Was Exit Interview Done?");
      const review = prompt("Final Review:");
      user.profile.exit = { date, reason, interview, review };
      saveUsers(users);
      alert("Employee marked as exited.");
    }

    function exportAttendance() {
      const attendance = getAttendance();
      let csv = "Username,Date\n";
      for (const user in attendance) {
        attendance[user].forEach(date => {
          csv += `${user},${date}\n`;
        });
      }
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "attendance.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function changePassword() {
      const oldPass = document.getElementById("oldPassword").value;
      const newPass = document.getElementById("newPassword").value;
      const users = getUsers();
      const user = users.find(u => u.username === hrUser);
      if (user.password === oldPass) {
        user.password = newPass;
        saveUsers(users);
        alert("Password updated.");
      } else {
        alert("Old password incorrect.");
      }
    }

    function logout() {
      localStorage.removeItem("loggedInHR");
      window.location.href = "index.html";
    }

    populateDepartments();
    setInterval(showAttendance, 1000);
  </script>
</body>
</html>
